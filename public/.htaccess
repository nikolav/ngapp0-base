# =============================================================================
# Angular Static + Prerendered HTML (.html / index.html) - safe .htaccess
# =============================================================================

DirectoryIndex index.html

<IfModule mod_rewrite.c>
RewriteEngine On

# ---------------------------------------------------------------------------
# 0) Basic guard: forbid path traversal-ish patterns (cheap safety)
# ---------------------------------------------------------------------------
RewriteCond %{THE_REQUEST} \.\. [NC,OR]
RewriteCond %{REQUEST_URI} \.\. [NC]
RewriteRule ^ - [F,L]

# ---------------------------------------------------------------------------
# 1) Serve existing files & directories directly
# ---------------------------------------------------------------------------
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# ---------------------------------------------------------------------------
# 2) Block hidden & sensitive files (before rewrites can expose them)
# ---------------------------------------------------------------------------
RewriteRule (^|/)\. - [F,L]

RewriteRule \.(env|log|ini|ya?ml|sql|bak|config|toml|lock|pem|key|crt)$ - [F,L,NC]

# Optional: block source maps in prod (uncomment if desired)
# RewriteRule \.map$ - [F,L,NC]

# ---------------------------------------------------------------------------
# 3) If request is for a route WITHOUT extension:
#    a) serve /route.html if it exists
#    b) serve /route/index.html if it exists
# ---------------------------------------------------------------------------
# Only apply to "pretty" URLs (no file extension)
RewriteCond %{REQUEST_URI} !\.[a-z0-9]{1,6}$ [NC]

# a) /about -> /about.html
RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI}.html -f
RewriteRule ^ %{REQUEST_URI}.html [L]

# b) /blog/post -> /blog/post/index.html
RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI}/index.html -f
RewriteRule ^ %{REQUEST_URI}/index.html [L]

# ---------------------------------------------------------------------------
# 4) SPA fallback (for routes that aren't prerendered)
# ---------------------------------------------------------------------------
RewriteRule ^ index.html [L]
</IfModule>

# ---------------------------------------------------------------------------
# Security headers (minimal & safe; CSP is app-specific, so omitted)
# ---------------------------------------------------------------------------
<IfModule mod_headers.c>
  Header always set X-Content-Type-Options "nosniff"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

# ---------------------------------------------------------------------------
# Caching
# - index.html and html: no-cache (so deploy updates quickly)
# - static assets: long cache (Angular uses hashed filenames)
# ---------------------------------------------------------------------------
<IfModule mod_headers.c>
  <FilesMatch "^(index\.html|.*\.html)$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
  </FilesMatch>

  <FilesMatch "\.(css|js|mjs|png|jpg|jpeg|gif|svg|webp|ico|woff2?|ttf|eot)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
</IfModule>

# ---------------------------------------------------------------------------
# Compression (brotli if available, else gzip)
# ---------------------------------------------------------------------------
<IfModule mod_brotli.c>
  AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/css application/javascript application/json image/svg+xml
</IfModule>

<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/css application/javascript application/json image/svg+xml
</IfModule>
