# =============================================================================
# Angular Static + Prerendered HTML + SPA fallback (DocumentRoot)
# =============================================================================

DirectoryIndex index.html

<IfModule mod_rewrite.c>
  RewriteEngine On

  # ---------------------------------------------------------------------------
  # 0) Cheap request hardening
  # ---------------------------------------------------------------------------
  RewriteCond %{THE_REQUEST} \.\. [NC,OR]
  RewriteCond %{REQUEST_URI} \.\. [NC]
  RewriteRule ^ - [F,L]

  # ---------------------------------------------------------------------------
  # 1) Block hidden & sensitive files EARLY (before "existing files" short-circuit)
  # ---------------------------------------------------------------------------
  # Dotfiles anywhere (/.git, /.env, /.well-known is ALSO dot-start; allow it below)
  RewriteCond %{REQUEST_URI} !^/\.well-known/ [NC]
  RewriteRule (^|/)\. - [F,L]

  # Common secrets / configs
  RewriteRule \.(?:env|log|ini|ya?ml|yml|sql|bak|config|toml|lock|pem|key|crt|pfx|p12)$ - [F,L,NC]

  # Optional: block sourcemaps in prod (uncomment if desired)
  # RewriteRule \.map$ - [F,L,NC]

  # ---------------------------------------------------------------------------
  # 2) Canonical: redirect direct .html requests to extensionless URLs
  #    /about.html -> /about   (keeps SEO clean, optional but recommended)
  # ---------------------------------------------------------------------------
  RewriteCond %{THE_REQUEST} \s/+(.+?)\.html[\s?] [NC]
  RewriteRule ^ %1 [R=301,L]

  # ---------------------------------------------------------------------------
  # 3) Serve existing files & directories directly
  # ---------------------------------------------------------------------------
  RewriteCond %{REQUEST_FILENAME} -f [OR]
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteRule ^ - [L]

  # ---------------------------------------------------------------------------
  # 4) Prerender resolution for "pretty" URLs (no extension):
  #    a) /route      -> /route.html   if exists
  #    b) /route/     -> /route/index.html if exists
  # ---------------------------------------------------------------------------
  # Only apply to URLs without an extension
  RewriteCond %{REQUEST_URI} !\.[a-z0-9]{1,8}$ [NC]

  # a) /about -> /about.html
  RewriteCond %{REQUEST_FILENAME}.html -f
  RewriteRule ^ %{REQUEST_URI}.html [L]

  # b) /blog/post -> /blog/post/index.html
  RewriteCond %{REQUEST_FILENAME}/index.html -f
  RewriteRule ^ %{REQUEST_URI}/index.html [L]

  # ---------------------------------------------------------------------------
  # 5) SPA fallback (only when not found as file/dir/html/index.html above)
  # ---------------------------------------------------------------------------
  RewriteRule ^ index.html [L]

</IfModule>

# =============================================================================
# Security headers (minimal & safe; CSP is app-specific)
# =============================================================================
<IfModule mod_headers.c>
  Header always set X-Content-Type-Options "nosniff"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

  # Optional: clickjacking protection (safe for most SPAs)
  Header always set X-Frame-Options "SAMEORIGIN"
</IfModule>

# =============================================================================
# Caching
# - HTML: no-cache (so deploy updates quickly)
# - Assets: long cache (Angular usually fingerprints filenames)
# =============================================================================
<IfModule mod_headers.c>
  <FilesMatch "\.html$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
  </FilesMatch>

  <FilesMatch "\.(?:css|js|mjs|map|png|jpg|jpeg|gif|svg|webp|ico|woff2?|ttf|eot)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
</IfModule>

# =============================================================================
# Compression (brotli if available, else gzip)
# =============================================================================
<IfModule mod_brotli.c>
  AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/css application/javascript application/json image/svg+xml
</IfModule>

<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/css application/javascript application/json image/svg+xml
</IfModule>
